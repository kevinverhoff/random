---
title: "4Leaf Solar"
output: html_document
date: "2025-09-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Total taxes

```{r}
library(scales)
library(dplyr)
total = 2400000
df = data.frame(categories = c('ðŸŽ“ Education','ðŸŽ“ Education','âš–ï¸ Local Government','â›‘ï¸ Public Safety'),
                recipients = c('Cloverdale\nCommunity Schools','South Putnam\nCommunity Schools','Putnam County','Greencastle\nFire Department'),
                amounts = c((1/3)*total,(1/6)*total,(1/3)*total,(1/6)*total)
                )

df = df %>%
  arrange(desc(categories)) %>%
  mutate(ypos = (cumsum(amounts) - amounts / 2),
         amounts_label = dollar(amounts),
         x_label = 1.9,
         angle = 360 * (ypos / sum(amounts)),
         hjust = ifelse(angle > 180, 1, 0),
         tooltip_text = paste0(recipients, "\nAmount: ", amounts_label,"\nCategory: ",categories))

df_sum = df %>%
            group_by(categories) %>%
            summarize(cat_total = sum(amounts),
                   cat_total_label = dollar(cat_total)) %>%
            mutate(label_clean = paste0(categories,':\n',cat_total_label))

df <- df %>%
  left_join(df_sum %>% select(categories, label_clean), by = "categories") %>%
  arrange(desc(categories)) %>%
  mutate(
    ypos = (cumsum(amounts) - amounts / 2),
    amounts_label = dollar(amounts),
    hjust = ifelse(360 * (ypos / sum(amounts)) > 180, 1, 0)
  )

# Build color map dynamically
color_map <- setNames(
  c("#679436", "#bbe5ed", "#db5461"),
  df_sum$label_clean
)

```

```{r}
library(ggplot2)
# Plot donut chart
p <- ggplot(df, aes(x = 2, y = amounts, fill = label_clean)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  geom_text(
    data = df,
    aes(x = 2.5, y = ypos, label = paste0(recipients, ":\n", amounts_label,0), hjust=hjust), 
    inherit.aes = FALSE,
    color = "gray25", fontface = "bold", size = 4
  ) +
  coord_polar(theta = "y", start = 0, clip="off") +
  scale_fill_manual(values = color_map) +
  xlim(0.5, 2.5) +
  theme_minimal(base_size = 12) +
  labs(
    title = "4 Leaf Solar Community Payments",
    subtitle = "Annual Additional Revenue 4 Leaf Solar will Generate for Putnam County",
    fill = NULL
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "italic"),
    legend.position = "bottom",
    legend.text = element_text(hjust = 0.5),
    legend.justification = "center",
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    plot.title.position = "plot",
    plot.margin = margin(1, 1, 1, 1, "cm")
  ) +
  annotate("text", x = 0.5, y = 0, label = paste0("$2.4\nMillion"), size = 8, fontface = "bold", color="#2e3532")
  
p
```

```{r}
library(plotly)
plotly_build(p)
```

