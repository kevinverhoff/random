---
title: "4Leaf Solar"
output: html_document
date: "2025-09-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Total taxes

```{r}
library(scales)
library(dplyr)
total = 2400000
df = data.frame(categories = c('🎓 Education','🎓 Education','⚖️ Local Government','⛑️ Public Safety'),
                recipients = c('Cloverdale\nCommunity Schools','South Putnam\nCommunity Schools','Putnam County','Greencastle\nFire Department'),
                amounts = c((1/3)*total,(1/6)*total,(1/3)*total,(1/6)*total)
                )

df = df %>%
  arrange(desc(categories)) %>%
  mutate(ypos = (cumsum(amounts) - amounts / 2),
         amounts_label = dollar(amounts),
         x_label = 1.9,
         angle = 360 * (ypos / sum(amounts)),
         hjust = ifelse(angle > 180, 1, 0),
         tooltip_text = paste0(recipients, "\nAmount: ", amounts_label,"\nCategory: ",categories))

df_sum = df %>%
            group_by(categories) %>%
            summarize(cat_total = sum(amounts),
                   cat_total_label = dollar(cat_total)) %>%
            mutate(label_clean = paste0(categories,':\n',cat_total_label))

df <- df %>%
  left_join(df_sum %>% select(categories, label_clean), by = "categories") %>%
  arrange(desc(categories)) %>%
  mutate(
    ypos = (cumsum(amounts) - amounts / 2),
    amounts_label = dollar(amounts),
    hjust = ifelse(360 * (ypos / sum(amounts)) > 180, 1, 0)
  )

# Build color map dynamically
color_map <- setNames(
  c("#679436", "#bbe5ed", "#db5461"),
  df_sum$label_clean
)

df

```

```{r}
library(ggplot2)
# Plot donut chart
p <- ggplot(df, aes(x = 2, y = amounts, fill = label_clean)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  geom_text(
    data = df,
    aes(x = 2.5, y = ypos, label = paste0(recipients, ":\n", amounts_label,0), hjust=hjust), 
    inherit.aes = FALSE,
    color = "gray25", fontface = "bold", size = 4
  ) +
  coord_polar(theta = "y", start = 0, clip="off") +
  scale_fill_manual(values = color_map) +
  xlim(0.5, 2.5) +
  theme_minimal(base_size = 12) +
  labs(
    title = "4 Leaf Solar Community Payments",
    subtitle = "Annual Additional Revenue 4 Leaf Solar will Generate for Putnam County",
    fill = NULL
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "italic"),
    legend.position = "bottom",
    legend.text = element_text(hjust = 0.5),
    legend.justification = "center",
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    plot.title.position = "plot",
    plot.margin = margin(1, 1, 1, 1, "cm")
  ) +
  annotate("text", x = 0.5, y = 0, label = paste0("$2.4\nMillion"), size = 8, fontface = "bold", color="#2e3532")
  
p
```

```{r}
df
```


```{r}
library(plotly)
library(dplyr)
library(scales)
library(plotly)

total <- 2400000
df <- data.frame(
  categories = c('🎓 Education','🎓 Education','⚖️ Local Government','⛑️ Public Safety'),
  recipients = c('Cloverdale<br>Community Schools','South Putnam<br>Community Schools',
                 'Putnam County','Greencastle<br>Fire Department'),
  amounts = c((1/3)*total,(1/6)*total,(1/3)*total,(1/6)*total)
)

# Category totals (used in tooltip or annotation if you like)
df_sum <- df %>%
  group_by(categories) %>%
  summarize(cat_total = sum(amounts), .groups = "drop") %>%
  mutate(cat_total_label = dollar(cat_total))

# Merge for tooltips
df_plot <- df %>%
  left_join(df_sum, by = "categories") %>%
  mutate(
    amounts_label = dollar(amounts),
    tooltip_text = paste0(
      recipients, "<br>",
      "Category: ", categories, "<br>",
      "Amount: ", amounts_label, "<br>",
      "Category total: ", cat_total_label
    )
  )

# Colors keyed by category
color_map <- c(
  "🎓 Education" = "#679436",
  "⚖️ Local Government" = "#bbe5ed",
  "⛑️ Public Safety" = "#db5461"
)
slice_colors <- unname(color_map[df_plot$categories])

# Build plot
library(dplyr)
library(scales)
library(plotly)

total <- 2400000
df <- data.frame(
  categories = c('🎓 Education','🎓 Education','⚖️ Local Government','⛑️ Public Safety'),
  recipients = c('Cloverdale Community Schools','South Putnam Community Schools',
                 'Putnam County','Greencastle Fire Department'),
  amounts = c((1/3)*total,(1/6)*total,(1/3)*total,(1/6)*total)
)

# Category totals for legend
df_sum <- df %>%
  group_by(categories) %>%
  summarize(cat_total = sum(amounts), .groups = "drop") %>%
  mutate(cat_total_label = dollar(cat_total),
         legend_label = paste0(categories, ": ", cat_total_label))

# Merge totals back for tooltips
df_plot <- df %>%
  left_join(df_sum, by = "categories") %>%
  mutate(
    amounts_label = dollar(amounts),
    slice_label = paste0(recipients, "<br>", amounts_label),
    tooltip_text = paste0(
      recipients, "<br>",
      "Category: ", categories, "<br>",
      "Amount: ", amounts_label, "<br>",
      "Category total: ", cat_total_label
    )
  )

# Colors per category
color_map <- c(
  "🎓 Education" = "#679436",
  "⚖️ Local Government" = "#bbe5ed",
  "⛑️ Public Safety" = "#db5461"
)
slice_colors <- unname(color_map[df_plot$categories])

# Donut with labels on slices
p <- plot_ly() %>%
  add_pie(
    data = df_plot,
    labels = ~slice_label,          # show recipient + amount
    values = ~amounts,
    hovertext = ~tooltip_text,
    hoverinfo = "text",
    textinfo = "label",             # display the slice labels on the wedges
    textposition = "outside",
    marker = list(colors = slice_colors, line = list(color = "white", width = 1)),
    hole = 0.5,
    sort = FALSE,
    showlegend = FALSE              # suppress auto-legend
  )

# Add dummy scatter traces for custom legend
for (i in 1:nrow(df_sum)) {
  p <- p %>%
    add_trace(
      type = "scatter", mode = "markers",
      x = 0, y = 0,
      name = df_sum$legend_label[i],   # "Education: $1.2 Million"
      marker = list(size = 12, color = color_map[df_sum$categories[i]]),
      hoverinfo = "skip",
      showlegend = TRUE,
      opacity = 0
    )
}

# Layout: clean background, center annotation
p <- p %>%
  layout(
    title = list(
      text = "4 Leaf Solar Community Payments<br><sup><em>Annual Additional Revenue 4 Leaf Solar will Generate for Putnam County</em></sup>",
      x = 0.5, xanchor = "center"
    ),
    legend = list(
      orientation = "h",
      x = 0.5, xanchor = "center",
      y = -0.05, yanchor = "top"
    ),
    annotations = list(
      list(
        text = "$2.4<br>Million",
        x = 0, y = 0,
        showarrow = FALSE,
        font = list(size = 22, color = "#2e3532")
      )
    ),
    margin = list(l = 40, r = 40, t = 80, b = 80),
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE)
  )

p
```

```{r}
library(htmlwidgets)
saveWidget(p, "4leaf_solar_payments.html", selfcontained = TRUE)
```

